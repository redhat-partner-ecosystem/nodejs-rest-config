apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  annotations:
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/tags: git
  name: github-update-deployment
  labels:
    operator.tekton.dev/provider-type: community
spec:
  description: This task can be used to update image digest in a Git repo using kustomize
  params:
    - name: MANIFESTS_GIT
      type: string

    - name: GIT_REVISION
      type: string
    - name: GIT_BRANCH_REF
      type: string
    - name: GIT_PUSHER_NAME
      type: string
    - name: GIT_PUSHER_EMAIL
      type: string
    - name: GIT_COMMIT_MESSAGE
      type: string

    - name: CURRENT_IMAGE
      type: string
    - name: NEW_IMAGE
      type: string
    - name: NEW_DIGEST
      type: string
    - name: KUSTOMIZATION_PATH
      type: string
  
  #workspaces:
  #  - description: The workspace consisting of maven project.
  #    name: workspace
  workspaces:
    - mountPath: /workspace/source
      name: source

  results:
    - name: commit
      description: The commit SHA

  stepTemplate:
    envFrom:
      - secretRef:
          name: github-secrets

  steps:
    - name: validate-github
      image: image-registry.openshift-image-registry.svc:5000/nodejs-gitops-pipeline/gitops-cli:latest
      workingDir: $(workspaces.workspace.path)
      script: |
        echo "-> Validating authentication against github.com"

        gh auth status

        pwd

        ls -la

    - name: git-clone
      image: image-registry.openshift-image-registry.svc:5000/nodejs-gitops-pipeline/gitops-cli:latest
      workingDir: $(workspaces.source.path)
      volumeMounts:
        - mountPath: /gen-source
          name: gen-source

      script: |
        # clone the repo
        echo "-> cloning $(params.MANIFESTS_GIT)"

        rm -rf git-update-digest-workdir

        git clone $(params.MANIFESTS_GIT) git-update-digest-workdir

        pwd

        ls -la

    